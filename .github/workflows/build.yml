name: build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  IMAGE: hello-world

jobs:
  test-build-push-action:
    runs-on: dind-runner
    permissions:
      contents: read
      id-token: write
    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      with:
        fetch-depth: 0

    - name: Set up Crane
      uses: imjasonh/setup-crane@v0.4

    - name: Build and Push Docker Image
      id: build-container
      uses: ./build-push
      with:
        image: ${{ secrets.HARBOR_HOST }}/hello-world
        registry: ${{ secrets.HARBOR_HOST }}
        registry_username: ${{ secrets.HARBOR_USERNAME }}
        registry_password: ${{ secrets.HARBOR_PASSWORD }}
        context: './testdata'
        dockerfile: './testdata/Dockerfile'

    - name: Verify docker build and push
      run: |
        REGISTRY=$(echo "${{ secrets.HARBOR_HOST }}" | cut -d/ -f1)
        echo ${{ secrets.HARBOR_PASSWORD }} | crane auth login $REGISTRY --username ${{ secrets.HARBOR_USERNAME }} --password-stdin
        for tag in ${{ steps.build-container.outputs.tags }}; do
          image=${tag}@${{ steps.build-container.outputs.digest }}
          echo "Verifying image: $image"
          crane manifest $image
        done

  check-workflow-status:
    runs-on: kubernetes-runner
    permissions:
      contents: read
      actions: read
    steps:
    - name: Check Workflow Status
      id: check-workflow-status
      uses: eidp/actions-common/check-workflow-status@v0.4.0
      with:
        jobs: 'test-build-push-action'
        github-token: ${{ secrets.GITHUB_TOKEN }}
